ğŸ”§â€¯Faire en sorte que le moduleâ€¯prefix_alloc utilise un provider alias
Vous avez dÃ©jÃ  un provider NetBox dÃ©clarÃ© Ã  la racineâ€¯:

provider "netbox" {
  url             = var.netbox_url
  token           = var.netbox_token
  skip_tls_verify = true
}
Mais vous voulez que le module puisse choisir lâ€™un des deux alias (exâ€¯: netbox.stagingâ€¯ouâ€¯netbox.prod).
Pour celaâ€¯:

DÃ©clarez plusieurs providers Ã  la racine, chacun avec un alias.
Passez lâ€™alias au module grÃ¢ce Ã  lâ€™attribut providers du bloc module.
Dans le module, ne dÃ©clarez plus de bloc provider â€“ Terraform lâ€™associera automatiquement Ã  lâ€™alias transmis.
1ï¸âƒ£ Racine â€“ main.tf
terraform {
  required_version = ">= 1.3"

  required_providers {
    netbox = {
      source  = "cloudnativeapp/terraform-provider-netbox"
      version = ">= 0.19.0"
    }
  }
}

# ---- Provider Â«â€¯productionâ€¯Â» --------------------------------------------
provider "netbox" {
  alias          = "prod"
  url            = var.netbox_prod_url
  token          = var.netbox_prod_token
  skip_tls_verify = true
}

# ---- Provider Â«â€¯stagingâ€¯Â» -----------------------------------------------
provider "netbox" {
  alias          = "staging"
  url            = var.netbox_staging_url
  token          = var.netbox_staging_token
  skip_tls_verify = true
}

# ---- Variables ------------------------------------------------------------
variable "netbox_prod_url"        { type = string; default = "https://netbox.prod.example.com" }
variable "netbox_prod_token"      { type = string; sensitive = true }
variable "netbox_staging_url"    { type = string; default = "https://netbox.staging.example.com" }
variable "netbox_staging_token"  { type = string; sensitive = true }

# ---- Liste de rÃ©servations -----------------------------------------------
locals {
  reservations = [
    {
      name          = "private_rfc1918"
      aggregate_id  = 10
      prefix_length = 24
      tag_ids       = []
      env          = "prod"        # <- on indiquera lâ€™alias
    },
    {
      name          = "bgp_public"
      aggregate_id  = 20
      prefix_length = 24
      tag_ids       = ["bgp"]
      env          = "staging"
    }
  ]
}

# ---- Instanciation du module -----------------------------------------------
module "prefix_alloc" {
  for_each = { for r in local.reservations : r.name => r }

  source = "./modules/prefix_alloc"

  aggregate_id  = each.value.aggregate_id
  prefix_length = each.value.prefix_length
  tag_ids       = each.value.tag_ids
  description   = "Allocated by Terraform (${each.key})"
  role          = null
  status        = "active"

  # **Lâ€™alias est passÃ© iciâ€¯!** -----------------------------------------------
  providers = {
    netbox = netbox[each.value.env]   # `netbox.prod` ou `netbox.staging`
  }
}

# ---- Sorties ---------------------------------------------------------------
output "allocated_prefixes" {
  description = "Map de nom => CIDR allouÃ©"
  value       = { for k, m in module.prefix_alloc : k => m.allocated_prefix }
}

output "allocated_prefix_ids" {
  description = "Map de nom => ID NetBox du prefix allouÃ©"
  value       = { for k, m in module.prefix_alloc : k => m.allocated_prefix_id }
}
âš ï¸â€¯Remarque
each.value.env doit Ãªtre lâ€™un des alias dÃ©finis ("prod" ou "staging").
Vous pouvez aussi crÃ©er une variable provider_envâ€¯= "prod" / "staging" et lâ€™utiliser directement.

2ï¸âƒ£ Module â€“ modules/prefix_alloc/main.tf
Ne mettez plus de bloc provider.
Le provider sera injectÃ© depuis la racine via providers = { netbox = netbox.prod } (ou staging).

# â”€â”€ Recherche dâ€™un /24 disponible ----------------------------------------
data "netbox_prefix" "available_prefix" {
  available = true
  container = var.aggregate_id
  length    = var.prefix_length
  tags      = var.tag_ids
}

# â”€â”€ CrÃ©ation du prefix ----------------------------------------------------
resource "netbox_prefix" "allocated" {
  prefix      = data.netbox_prefix.available_prefix.prefix
  description = var.description
  role        = var.role
  status      = var.status
  tags        = var.tag_ids
}
Aucun provider nâ€™est prÃ©sent ici â€“ Terraform lâ€™associera Ã  lâ€™alias reÃ§u depuis la racine.

3ï¸âƒ£ Variables du module (inchangÃ©es) â€“ modules/prefix_alloc/variables.tf
variable "aggregate_id"  { type = number }
variable "prefix_length" { type = number }
variable "tag_ids"       { type = list(string); default = [] }
variable "description"   { type = string }
variable "role"          { type = string; default = null }
variable "status"        { type = string; default = null }
4ï¸âƒ£ Sorties du module â€“ modules/prefix_alloc/outputs.tf
output "allocated_prefix"   { value = netbox_prefix.allocated.prefix }
output "allocated_prefix_id" { value = netbox_prefix.allocated.id }
RÃ©sultat
Chaque rÃ©servation dans local.reservations indique quel alias (prod ou staging) doit Ãªtre utilisÃ©.
Le bloc module "prefix_alloc" transmet explicitement lâ€™alias (providers = { netbox = netbox.prod } ou netbox.staging).
Le module utilise ce provider, sans dÃ©clarer de bloc provider.
Si vous ajoutez un troisiÃ¨me environment (netbox.dev), ajoutez simplement un autre provider avec aliasâ€¯dev et Ã©tendez locals.reservations.env.
