Structure du projet
terraform-netbox/
â”œâ”€â”€ main.tf                 # EntrÃ©e principale
â”œâ”€â”€ variables.tf            # Variables globales
â”œâ”€â”€ outputs.tf              # Sorties globales
â”œâ”€â”€ versions.tf             # DÃ©claration du provider NetBox
â””â”€â”€ modules/
    â””â”€â”€ prefix_alloc/
        â”œâ”€â”€ main.tf         # Logique de rÃ©servation dâ€™un /24
        â”œâ”€â”€ variables.tf    # Variables du module
        â””â”€â”€ outputs.tf      # Sorties du module
ğŸ”‘ Contenu complet
1ï¸âƒ£ main.tf (racine)
terraform {
  required_version = ">= 1.3"

  required_providers {
    netbox = {
      source  = "cloudnativeapp/terraform-provider-netbox"
      version = ">= 0.19.0"
    }
  }
}

# --- Provider Ã  la racine (sans alias) -----------------------------------
provider "netbox" {
  url             = var.netbox_url
  token           = var.netbox_token
  skip_tls_verify = true
}

# --- Exemple de liste de rÃ©servations ------------------------------------
locals {
  reservations = [
    {
      name          = "private_rfc1918"
      aggregate_id  = 10          # ID dâ€™un aggregate 10.0.0.0/8 dans NetBox
      prefix_length = 24
      tag_ids       = []          # pas de tags Ã  filtrer
    },
    {
      name          = "bgp_public"
      aggregate_id  = 20          # ID dâ€™un aggregate 203.0.113.0/24 dans NetBox
      prefix_length = 24
      tag_ids       = ["bgp"]     # tag(s) qui doivent Ãªtre prÃ©sents
    }
  ]
}

# --- Instanciation du module pour chaque rÃ©servation ----------------------
module "prefix_alloc" {
  for_each = { for r in local.reservations : r.name => r }

  source       = "./modules/prefix_alloc"
  aggregate_id = each.value.aggregate_id
  prefix_length = each.value.prefix_length
  tag_ids     = each.value.tag_ids
  description = "Allocated by Terraform (${each.key})"
  role        = null
  status      = "active"
}

# --- Sorties de haut niveau ----------------------------------------------
output "allocated_prefixes" {
  description = "Map de nom => CIDR allouÃ©"
  value       = { for k, m in module.prefix_alloc : k => m.allocated_prefix }
}

output "allocated_prefix_ids" {
  description = "Map de nom => ID NetBox du prefix allouÃ©"
  value       = { for k, m in module.prefix_alloc : k => m.allocated_prefix_id }
}
2ï¸âƒ£ variables.tf (racine)
variable "netbox_url" {
  description = "URL de lâ€™instance NetBox (ex : http://localhost:2025)"
  type        = string
  default     = "http://localhost:2025"
}

# On ne donne pas de default pour le token â€“ il sera fourni via TF_VAR_â€¦
variable "netbox_token" {
  description = "Token dâ€™API NetBox (Ã  mettre dans TF_VAR_netbox_token)"
  type        = string
  sensitive   = true
}

variable "aggregate_id" { /* pas utilisÃ© directement ici, mais prÃ©sent pour documentation */
  description = "Id dâ€™aggregate (pour les variables locales)"
  type        = number
}
Important
Si vous utilisez un token dâ€™environnement vous nâ€™avez rien Ã  mettre dans default.

export TF_VAR_netbox_token="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
3ï¸âƒ£ outputs.tf (racine)
output "allocated_prefixes" {
  description = "Map de nom => CIDR allouÃ©"
  value       = { for k, m in module.prefix_alloc : k => m.allocated_prefix }
}

output "allocated_prefix_ids" {
  description = "Map de nom => ID NetBox du prefix allouÃ©"
  value       = { for k, m in module.prefix_alloc : k => m.allocated_prefix_id }
}
4ï¸âƒ£ versions.tf (racine)
(Facultatif â€“ il suffit dâ€™avoir le bloc required_providers dans main.tf, mais pour garder les choses sÃ©parÃ©es on peut le mettre dans un fichier dÃ©diÃ©)

terraform {
  required_version = ">= 1.3"

  required_providers {
    netbox = {
      source  = "cloudnativeapp/terraform-provider-netbox"
      version = ">= 0.19.0"
    }
  }
}
5ï¸âƒ£ modules/prefix_alloc/main.tf
# --- DonnÃ©es pour trouver un /24 disponible dans lâ€™aggregate --------------
data "netbox_prefix" "available_prefix" {
  available = true
  container = var.aggregate_id
  length    = var.prefix_length
  tags      = var.tag_ids
}

# --- CrÃ©ation rÃ©elle du prefix -------------------------------------------
resource "netbox_prefix" "allocated" {
  prefix      = data.netbox_prefix.available_prefix.prefix
  description = var.description
  role        = var.role
  status      = var.status
  tags        = var.tag_ids
}
6ï¸âƒ£ modules/prefix_alloc/variables.tf
variable "aggregate_id" {
  description = "ID du container (aggregate) Ã  partir duquel rÃ©server"
  type        = number
}

variable "prefix_length" {
  description = "Longueur du prefix Ã  rÃ©server (24 pour un /24)"
  type        = number
}

variable "tag_ids" {
  description = "Tags qui doivent Ãªtre prÃ©sents sur le prefix (optionnel)"
  type        = list(string)
  default     = []
}

variable "description" {
  description = "Description qui sera ajoutÃ©e dans NetBox"
  type        = string
}

variable "role" {
  description = "RÃ´le NetBox (optionnel)"
  type        = string
  default     = null
}

variable "status" {
  description = "Statut NetBox (exâ€¯: 'active')"
  type        = string
  default     = null
}
7ï¸âƒ£ modules/prefix_alloc/outputs.tf
output "allocated_prefix" {
  description = "Le CIDR allouÃ©"
  value       = netbox_prefix.allocated.prefix
}

output "allocated_prefix_id" {
  description = "Id NetBox du prefix crÃ©Ã©"
  value       = netbox_prefix.allocated.id
}
âœ…â€¯Comment lâ€™utiliser
Initialisation

cd terraform-netbox
terraform init
VÃ©rifiez que vous avez fourni un token

export TF_VAR_netbox_token="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
Voir le plan

terraform plan
Vous devriez voir Â«â€¯netbox_prefix.allocatedâ€¯Â» dans la liste des ressources crÃ©Ã©es.

Appliquer

terraform apply
ğŸš€ Variante avec plusieurs aggregates via count
Si vous ne voulez pas gÃ©rer la liste dans un local, vous pouvez passer une variable de type list(object({ â€¦ })) et lâ€™utiliser avec for_each comme montrÃ© ciâ€‘dessus.
Pour un simple /24, la liste ne contient quâ€™un seul Ã©lÃ©ment.

ğŸ› ï¸ Bonusâ€¯: Utiliser lâ€™environnent
Vous pouvez lier le token Ã  la variable netbox_token avec :

variable "netbox_token" {
  description = "Token dâ€™API NetBox (Ã  mettre dans TF_VAR_netbox_token)"
  type        = string
  sensitive   = true
}
Et dans votre shell :

export TF_VAR_netbox_token="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
Aucune valeur par dÃ©faut nâ€™est alors nÃ©cessaire et Terraform gardera le champ sensible horsâ€‘ligne.

ğŸ“œ RÃ©sumÃ©
Chemin	Fichier	Contenu
main.tf	Racine	Provider, providerâ€‘definition, locals, for_each module, outputs
variables.tf	Racine	netbox_url, netbox_token (sans default)
outputs.tf	Racine	allocated_prefixes, allocated_prefix_ids
versions.tf	Racine	Provider NetBox (facultatif mais recommandÃ©)
modules/prefix_alloc/main.tf	Module	Data source + resource NetBox prefix
modules/prefix_alloc/variables.tf	Module	aggregate_id, prefix_length, tag_ids, description, role, status
modules/prefix_alloc/outputs.tf	Module	allocated_prefix, allocated_prefix_id
Avec ces fichiers, toutes les rÃ©servations listÃ©es dans local.reservations seront crÃ©Ã©es Ã  chaque apply, et terraform plan vous montrera les changements Ã  venir. ğŸš€

Downloading model
0 B / 0 B (0%)
